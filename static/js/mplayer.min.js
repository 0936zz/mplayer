/**
 * MPlayer音乐播放器
 * @authors 0936zz(zz5840@qq.com)
 * 本插件依赖：jQuery 1.6及以上
 */
var MPlayer=(function(){function a(e,j){var h=this;k(j);f();b();h.changePlayMode(h.settings.playMode);var c="";$.each(h.list,function(l){c+='<li class="mp-list-title-'+l+'">'+h.list[l].listName+"</li>"});h.dom.listTitle.html(c);h._setLrc(h.list[0][0].lrc);h.changeList(h.settings.playList);h._trigger("afterInit");if(h.settings.autoPlay){h.play(h.settings.playList,h.settings.playSong)}else{h._setInfo(h.settings.playList,h.settings.playSong)}function k(m){h.settings={playMode:3,playList:0,playSong:0,autoPlay:false,lrcTopPos:0,defaultVolume:100};h.callbacks={afterInit:null,beforePlay:null,timeUpdate:null,end:null,mute:null,changeMode:null};$.extend(true,h.settings,e);var l=$(h.settings.containerSelector);h.audio=$("<audio></audio>").attr({"data-currentLrc":0,"data-currentSong":0,"data-currentList":0,"data-displayList":0,"data-playMode":0,"preload":"preload"});h.dom={container:l,cover:l.find(".mp-cover"),name:l.find(".mp-name"),singer:l.find(".mp-singer"),currentTime:l.find(".mp-time-current"),allTime:l.find(".mp-time-all"),prev:l.find(".mp-prev"),play:l.find(".mp-pause"),next:l.find(".mp-next"),vol:l.find(".mp-vol-img"),volRange:l.find(".mp-vol-range"),progress:l.find(".mp-pro-current"),progressAll:l.find(".mp-pro"),lrc:l.find(".mp-lrc"),listTitle:l.find(".mp-list-title"),list:l.find(".mp-list")};h.settings.lineHeight=parseInt(h.dom.lrc.css("line-height"));h.settings.listEleName=$.parseHTML(h.settings.listFormat)[0].nodeName.toLowerCase();m.apply(h)}function f(){h.dom.cover.error(function(){$(this).attr("src",h.settings.defaultImg)});h.dom.prev.click(function(){h.prev()});h.dom.next.click(function(){h.next()});h.dom.play.click(function(){if(h.audio.prop("paused")){h.play()}else{h.pause()}});h.dom.volRange.on(h.settings.volSlideEventName,function(m,n){h.audio.prop("volume",n/100)});h.dom.vol.click(function(){h.toggleMute()});h.dom.listTitle.on("click","li",function(){var m=$(this).index();h.changeList(m)});h.audio.on("canplay",function(){i(h.getDuration(),h.dom.allTime)}).on("timeupdate",function(){var n=h.getCurrentTime();i(n,h.dom.currentTime);h.dom.progress.css("width",h.getPercent()*100+"%");var r=parseInt(h.audio.attr("data-currentLrc"));var q=h.getLrc(n,false);if(r!=q){h.audio.attr("data-currentLrc",q);h.dom.lrc.find(".mp-lrc-current").removeClass("mp-lrc-current");var m=h.dom.lrc.find(".mp-lrc-time-"+q).addClass("mp-lrc-current").position();var o=m?m.top:0;var p=h.dom.lrc.scrollTop();h.dom.lrc.animate({scrollTop:p+o-h.settings.lrcTopPos},200)}h._trigger("timeUpdate")}).on("ended",function(){var m=h._trigger("end");if(m!==false){g()}});var l=$.parseHTML(h.settings.listFormat)[0].nodeName.toLowerCase();h.dom.list.on("click",l,function(){h.play(parseInt(h.audio.attr("data-displayList")),$(this).index())});h.dom.progressAll.click(function(o){var m=$(this).width();var p=Math.min(Math.max(o.offsetX,0),m);var n=p/m;h.setCurrentTime(h.getDuration()*n)});h.dom.list.on("click",h.settings.listEleName,function(){h.play(parseInt(h.audio.attr("data-displayList")),$(this).index())});h.dom.container.on("mousedown",".mp-disabled",function(){return false})}function b(){h.list=[];var n=h.settings.songList;for(var m=0;m<n.length;m++){h.list[m]=[];for(var l=0;l<n[m].length;l++){if(n[m][l].basic){h.list[m].listName=n[m][l].name||"-";h.list[m].singerName=n[m][l].singer||"-";h.list[m].imgSrc=n[m][l].img||h.settings.defaultImg;n[m].splice(l,1);break}}h.addSong(n[m],m)}}function g(){var n=parseInt(h.audio.attr("data-playMode"));var l=h.getSongNum();switch(n){case 0:var m=h.audio.attr("data-currentSong");if(m!=l-1){h.next()}else{h.pause()}break;case 1:h.play();break;case 2:case 3:default:h.next();break}}function i(n,m){var o=d(Math.floor(n/60),2);var l=d(Math.floor(n%60),2);m.html(o+":"+l)}function d(l,n){l=String(l);for(var m=l.length;m<n;m++){l="0"+l}return l}}$.extend(a.prototype,{_setLrc:function(b){var c=this;c.dom.lrc.html("").scrollTop(0);$.each(b,function(d,e){c.dom.lrc.append($("<li></li>").addClass("mp-lrc-time-"+d).html(e))})},_setInfo:function(c,e){var d=this;var b=d.getInfo(c,e);d.audio.attr({"src":b.src,"data-currentList":c,"data-currentSong":e});d.dom.name.html(b.name);d.dom.singer.html(b.singer);d.dom.cover.attr("src",b.img);d._setLrc(b.lrc);d.dom.progress.width(0);if(c==d.getDisplayList()){d._setCurrent(e)}},_setCurrent:function(d){var c=this;var b=c.dom.list;b.find(".mp-list-current").removeClass("mp-list-current");b.children().eq(d).addClass("mp-list-current")},_parseLrc:function(c){var d=/\[(\d{2})(&#58;|:)(\d{2})(&#46;|\.)(\d{2})\]([^\[]+)/g;var f={};while(true){var b=d.exec(c);if(!b){break}var e=Math.round((parseInt(b[1])*60+parseInt(b[3])+parseInt(b[5])/100)*1000);f[e]=$.trim(b[6])||" "}return f},_trigger:function(b){var c=this;return c.callbacks[b]&&c.callbacks[b].apply(c)},_rand:function(c,b){if(b===undefined){b=c;c=0}var d=0;do{d=Math.round(Math.random()*b)}while(d<c);return d},next:function(){var d=this;var f=d.getPlayMode();var c=d.getSongNum();switch(f){case 2:var e=d._rand(0,c-1);d.play(e);break;case 0:case 3:case 1:default:var b=d.getCurrentSong()+1;if(b>=c){b=0}d.play(b);break}},prev:function(){var c=this;var d=c.getCurrentSong()-1;var b=c.getCurrentList(true);if(d<0){d=b.num-1}c.play(d)},play:function(d,f){var e=this;if(d===undefined&&f===undefined){var b=e._trigger("beforePlay");if(b===false){return false}else{e.audio.get(0).play();e.dom.play.addClass("mp-play")}}else{if(d!==undefined&&f===undefined){f=d;d=e.getCurrentList();e.play(d,f)}else{var c=e.getSongNum(d);if(f>=c){f=c-1}else{if(f<0){f=0}}e._setInfo(d,f);e.play()}}},pause:function(){var b=this;b.dom.play.removeClass("mp-play");b.audio.get(0).pause()},getDuration:function(){return this.audio.prop("duration")},getCurrentTime:function(){return this.audio.prop("currentTime")},getPercent:function(){return this.getCurrentTime()/this.getDuration()},setCurrentTime:function(e){var d=this;e=Math.min(e,d.getDuration());e=Math.max(0,e);var c=d.audio.get(0).buffered;var f=c.start(0);var b=c.end(0);e=Math.max(f,Math.min(b,e));d.audio.prop("currentTime",e)},addSong:function(e,d){var f=this;d=d!==undefined?d:f.getCurrentList();if(e instanceof Array){for(var c=0;c<e.length;c++){f.addSong(e[c],d)}}else{var b={lrc:f._parseLrc(e.lrc||"-"),name:e.name||"-",singer:e.singer||f.list[d].singerName,src:e.src||"-",img:e.img||f.list[d].imgSrc};var g=$.extend({},e,b);f.list[d].push(g);if(d==f.getCurrentList()){f.changeList(d)}}},getSongNum:function(b){var c=this;b=b!==undefined?b:c.getCurrentList();return c.list[b].length},getCurrentSong:function(c){var b=this;c=c!==undefined?c:false;if(c){return b.getInfo()}else{return parseInt(b.audio.attr("data-currentSong"))}},getCurrentList:function(c){var b=this;c=c!==undefined?c:false;if(c){return b.getList(b.getCurrentList())}else{return parseInt(b.audio.attr("data-currentList"))}},getDisplayList:function(c){var b=this;c=c!==undefined?c:false;if(c){return b.getList(b.getDisplayList())}else{return parseInt(b.audio.attr("data-displayList"))}},getList:function(c){var d=this;var b=d.list[c];return{name:b.listName,num:b.length,songs:b}},getInfo:function(b,d){var c=this;b=b!==undefined?b:c.getCurrentList();d=d!==undefined?d:c.getCurrentSong();return c.list[b][d]},getLrc:function(f,e){var d=this;e=e!==undefined?e:true;f=f!==undefined?f*1000:d.getCurrentTime()*1000;var b=d.getCurrentSong(true)["lrc"];var c,g=0;$.each(b,function(h){if(f<h){return false}g=h});c=g;return e?d.getCurrentSong(true).lrc[c]:c},changeList:function(f){var h=this;h.dom.listTitle.find(".mp-list-title-current").removeClass("mp-list-title-current");h.dom.listTitle.find(".mp-list-title-"+f).addClass("mp-list-title-current");h.audio.attr("data-displayList",f);h.dom.list.html("");var g=h.settings.listFormat;var d=/\$\{(\w+)}\$/g;for(var c=0;c<h.list[f].length;c++){var e=g;while(true){var b=d.exec(g);if(!b){break}e=e.replace(b[0],h.list[f][c][b[1]]||"-")}h.dom.list.append(e)}if(f==h.getCurrentList()){h._setCurrent(h.getCurrentSong())}},changePlayMode:function(c){var b=this;c=Math.max(Math.min(parseInt(c),3),0);b.audio.attr("data-playMode",c);b._trigger("changeMode")},getPlayMode:function(){return parseInt(this.audio.attr("data-playMode"))},getIsMuted:function(){return this.audio.prop("muted")},mute:function(){var b=this;b.dom.vol.addClass("mp-mute");b.audio.prop("muted",true);b._trigger("mute")},cancelMute:function(){var b=this;b.audio.prop("muted",false);b.dom.vol.removeClass("mp-mute");b._trigger("mute")},toggleMute:function(){var b=this;if(b.getIsMuted()){b.cancelMute()}else{b.mute()}},on:function(c,b){var d=this;d.callbacks[c]=b;return d},unBindEvent:function(b){var c=this;c.callbacks[b]=null;return c}});return a}());